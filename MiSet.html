<!doctype html>
<html>
<head>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Mirror Setup</title>
<style>
/* Default dark mode - midnight black */
:root {
  --bg-color: #000000;
  --card-bg: #111111;
  --text-color: #eee;
  --input-bg: #1a1a1a;
  --input-border: #333;
  --btn-primary-bg: #0d6efd;
  --btn-primary-text: #fff;
  --btn-ghost-bg: #1a1a1a;
  --btn-ghost-border: #333;
  --status-bg: #111;
  --danger-bg: #dc3545;
  --success: #28a745;
  --warning: #ffc107;
  --danger: #dc3545;
}

body.light {
  --bg-color: #f9f9f9;
  --card-bg: #fff;
  --text-color: #222;
  --input-bg: #fff;
  --input-border: #ccc;
  --btn-primary-bg: #111;
  --btn-primary-text: #fff;
  --btn-ghost-bg: #fff;
  --btn-ghost-border: #ddd;
  --status-bg: #f6f8fa;
  --danger-bg: #dc3545;
}

body {
  font-family: system-ui, Arial;
  margin: 18px;
  background-color: var(--bg-color);
  color: var(--text-color);
  transition: background-color 0.3s, color 0.3s;
}

.card {
  max-width: 640px;
  margin: 8px auto;
  padding: 18px;
  border-radius: 10px;
  box-shadow: 0 6px 18px rgba(0,0,0,0.5);
  background-color: var(--card-bg);
  transition: background-color 0.3s, box-shadow 0.3s;
}

h1 { margin:0 0 10px; font-size:20px; }

.label { 
  font-weight:600; 
  margin-top:12px; 
  display:flex;
  align-items:center;
  gap:6px;
}

input, select, button {
  width:100%;
  box-sizing: border-box;
  padding:10px;
  margin-top:6px;
  border-radius:8px;
  border:1px solid var(--input-border);
  background-color: var(--input-bg);
  color: var(--text-color);
  transition: background-color 0.3s, border-color 0.3s, color 0.3s;
  font-size: 16px;
}

.row { display:flex; gap:8px; }
.row > * { flex:1; }

.small { font-size:13px; color:#aaa; margin-top:6px; }

.btn-primary { background: var(--btn-primary-bg); color: var(--btn-primary-text); border:none; cursor:pointer; }
.btn-ghost { background: var(--btn-ghost-bg); border:1px solid var(--btn-ghost-border); cursor:pointer; }
.btn-danger { background: var(--danger-bg); color: #fff; border:none; cursor:pointer; }

.status { 
  margin-top:12px; 
  padding:8px; 
  border-radius:6px; 
  background: var(--status-bg); 
  color: var(--text-color);
  display:flex;
  align-items:center;
  gap:8px;
  transition: background-color 0.3s, color 0.3s;
}

#theme-toggle {
  cursor:pointer;
  font-size:24px;
  user-select:none;
  background:none;
  border:none;
  padding:0;
  width:auto;
  margin:0;
}

.mirror-text {
  text-align: center;
  font-size: clamp(24px, 8vw, 48px);
  font-weight: bold;
  letter-spacing: clamp(8px, 2vw, 16px);
  margin: 20px 0 20px;
  color: var(--text-color);
  white-space: nowrap;
  overflow: hidden;
  transition: color 0.3s;
}

.restart-row {
  display:flex;
  gap:8px;
  margin-top:12px;
  align-items:stretch;
}

.input-with-icon {
  position:relative;
  display:flex;
  align-items:center;
}

.input-with-icon input {
  padding-right:40px;
}

.input-icon {
  position:absolute;
  right:12px;
  cursor:pointer;
  font-size:18px;
  user-select:none;
}

.wifi-row {
  display:flex;
  gap:8px;
  align-items:flex-end;
}

.wifi-row select {
  flex:1;
}

.wifi-row button {
  width:auto;
  padding:10px 16px;
}

.info-icon {
  display:inline-block;
  width:16px;
  height:16px;
  border-radius:50%;
  background:var(--input-border);
  color:var(--text-color);
  text-align:center;
  line-height:16px;
  font-size:12px;
  cursor:help;
  position:relative;
}

.info-icon:active .tooltip {
  display:block;
}

@media (hover: hover) {
  .info-icon:hover .tooltip {
    display:block;
  }
}

.tooltip {
  display:none;
  position:absolute;
  bottom:24px;
  left:50%;
  transform:translateX(-50%);
  background:var(--card-bg);
  border:1px solid var(--input-border);
  padding:8px 12px;
  border-radius:6px;
  white-space:nowrap;
  font-size:12px;
  font-weight:normal;
  z-index:10;
  box-shadow:0 4px 12px rgba(0,0,0,0.3);
  pointer-events:none;
}

.connection-indicator {
  width:10px;
  height:10px;
  border-radius:50%;
  display:inline-block;
  margin-right:4px;
}

.connection-indicator.disconnected { background:var(--danger); }
.connection-indicator.connecting { background:var(--warning); animation:pulse 1s infinite; }
.connection-indicator.connected { background:var(--success); }

@keyframes pulse {
  0%, 100% { opacity:1; }
  50% { opacity:0.5; }
}

.progress-steps {
  display:flex;
  justify-content:space-between;
  margin:20px 0;
  position:relative;
}

.progress-steps::before {
  content:'';
  position:absolute;
  top:15px;
  left:0;
  right:0;
  height:2px;
  background:var(--input-border);
  z-index:0;
}

.step {
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:6px;
  position:relative;
  z-index:1;
  flex:1;
  cursor:pointer;
}

.step-circle {
  width:30px;
  height:30px;
  border-radius:50%;
  background:var(--input-bg);
  border:2px solid var(--input-border);
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:14px;
  font-weight:bold;
  transition: background-color 0.3s, border-color 0.3s;
}

.step:hover .step-circle {
  border-color:var(--btn-primary-bg);
}

.step.active .step-circle {
  background:var(--btn-primary-bg);
  border-color:var(--btn-primary-bg);
  color:#fff;
}

.step.completed .step-circle {
  background:var(--success);
  border-color:var(--success);
  color:#fff;
}

.step-label {
  font-size:11px;
  text-align:center;
}

.device-info {
  margin-top:20px;
  padding:12px;
  background:var(--status-bg);
  border-radius:8px;
  font-size:13px;
  transition: background-color 0.3s;
}

.device-info-row {
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin:4px 0;
}

.modal {
  display:none;
  position:fixed;
  top:0;
  left:0;
  right:0;
  bottom:0;
  background:rgba(0,0,0,0.7);
  z-index:100;
  align-items:center;
  justify-content:center;
}

.modal.show {
  display:flex;
}

.modal-content {
  background:var(--card-bg);
  padding:24px;
  border-radius:12px;
  max-width:400px;
  margin:20px;
  box-shadow:0 8px 24px rgba(0,0,0,0.5);
  transition: background-color 0.3s;
}

.modal-title {
  font-size:18px;
  font-weight:bold;
  margin-bottom:12px;
}

.modal-buttons {
  display:flex;
  gap:8px;
  margin-top:16px;
}

.modal-buttons button {
  flex:1;
}

.setup-section {
  display:none;
}

.setup-section.visible {
  display:block;
}
</style>
</head>
<body>
<div class="mirror-text">M I R R O R</div>

<div class="card">
  <h1>Mirror Setup</h1>
  <div>Connect your phone to the network named <strong>Mirror-Setup</strong>, then use this page.</div>

  <!-- Progress Steps -->
  <div class="progress-steps">
    <div class="step" id="step1" onclick="goToStep(1)">
      <div class="step-circle">1</div>
      <div class="step-label">Name</div>
    </div>
    <div class="step" id="step2" onclick="goToStep(2)">
      <div class="step-circle">2</div>
      <div class="step-label">WiFi</div>
    </div>
    <div class="step" id="step3" onclick="goToStep(3)">
      <div class="step-circle">3</div>
      <div class="step-label">Pair</div>
    </div>
    <div class="step" id="step4" onclick="goToStep(4)">
      <div class="step-circle">4</div>
      <div class="step-label">Done</div>
    </div>
  </div>

  <label class="label">
    Mirror Name
    <span class="info-icon">i
      <span class="tooltip">Give your mirror a unique name (max 15 characters)</span>
    </span>
  </label>
  <input id="name" placeholder="eg. Mirror-Bathroom" maxlength="15" oninput="updateRestartText()">

  <div class="setup-section" id="section-wifi">
    <label class="label">
      Wi-Fi Network
      <span class="info-icon">i
        <span class="tooltip">Select the WiFi network you want to connect to</span>
      </span>
    </label>
    <div class="wifi-row">
      <select id="wifi"></select>
      <button onclick="refreshWifi()">üîÑ</button>
    </div>

    <label class="label">
      Wi-Fi Password
      <span class="info-icon">i
        <span class="tooltip">Enter the password for the selected network</span>
      </span>
    </label>
    <div class="input-with-icon">
      <input id="password" type="password" placeholder="Wi-Fi password">
      <span class="input-icon" onclick="togglePassword()">üëÅÔ∏è</span>
    </div>

    <label class="label">
      Time Zone
      <span class="info-icon">i
        <span class="tooltip">Select your time zone for accurate time display</span>
      </span>
    </label>
    <select id="timezone">
      <option value="America/New_York">Eastern Time (ET)</option>
      <option value="America/Chicago">Central Time (CT)</option>
      <option value="America/Denver">Mountain Time (MT)</option>
      <option value="America/Los_Angeles">Pacific Time (PT)</option>
      <option value="America/Anchorage">Alaska Time (AKT)</option>
      <option value="Pacific/Honolulu">Hawaii Time (HT)</option>
      <option value="Europe/London">London (GMT)</option>
      <option value="Europe/Paris">Paris (CET)</option>
      <option value="Asia/Tokyo">Tokyo (JST)</option>
      <option value="Australia/Sydney">Sydney (AEDT)</option>
    </select>

    <div style="margin-top:12px">
      <button class="btn-primary" onclick="save()">Save & Connect</button>
    </div>
  </div>

  <div class="setup-section" id="section-pair">
    <div style="margin-top:12px">
      <button class="btn-ghost" onclick="pair()">Pair Earbuds</button>
    </div>
  </div>

  <div class="setup-section" id="section-complete">
    <div style="margin-top:12px">
      <button id="restart-btn" onclick="restart()">Restart Mirror after setup</button>
    </div>

    <div style="margin-top:12px">
      <button class="btn-danger" onclick="showFactoryResetModal()">Factory Reset</button>
    </div>
  </div>

  <div id="status" class="status small">
    <span class="connection-indicator disconnected" id="connection-indicator"></span>
    <span id="status-text">Status: idle</span>
  </div>

  <!-- Device Info -->
  <div class="device-info">
    <div class="device-info-row" style="font-weight:600;margin-bottom:8px;">
      <span>Device Information</span>
      <span id="theme-toggle">‚òÄÔ∏è</span>
    </div>
    <div class="device-info-row">
      <span>Firmware Version:</span>
      <span id="firmware-version">v0.0.1</span>
    </div>
  </div>
</div>

<!-- Factory Reset Modal -->
<div class="modal" id="factory-reset-modal">
  <div class="modal-content">
    <div class="modal-title">‚ö†Ô∏è Factory Reset</div>
    <div>This will erase all settings and restart the mirror. This action cannot be undone.</div>
    <div class="modal-buttons">
      <button class="btn-ghost" onclick="hideFactoryResetModal()">Cancel</button>
      <button class="btn-danger" onclick="confirmFactoryReset()">Reset</button>
    </div>
  </div>
</div>

<script>
let passwordVisible = false;

function setStatus(t, status = 'idle'){ 
  document.getElementById("status-text").textContent = "Status: "+t;
  const indicator = document.getElementById("connection-indicator");
  indicator.className = 'connection-indicator';
  
  if(status === 'connecting') {
    indicator.classList.add('connecting');
  } else if(status === 'connected') {
    indicator.classList.add('connected');
  } else {
    indicator.classList.add('disconnected');
  }
}

function goToStep(stepNum) {
  // Clear all active states
  document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
  
  // Hide all sections
  document.getElementById('section-wifi').classList.remove('visible');
  document.getElementById('section-pair').classList.remove('visible');
  document.getElementById('section-complete').classList.remove('visible');
  
  // Set current step as active
  document.getElementById('step' + stepNum).classList.add('active');
  
  // Show appropriate section
  if(stepNum === 2) {
    document.getElementById('section-wifi').classList.add('visible');
  } else if(stepNum === 3) {
    document.getElementById('section-pair').classList.add('visible');
  } else if(stepNum === 4) {
    document.getElementById('section-complete').classList.add('visible');
  }
}

function updateRestartText() {
  const name = document.getElementById('name').value.trim();
  const restartBtn = document.getElementById('restart-btn');
  if (name) {
    restartBtn.textContent = `Restart ${name} after setup`;
  } else {
    restartBtn.textContent = 'Restart Mirror after setup';
  }
  
  // Update progress step and reveal next section
  if(name) {
    document.getElementById('step1').classList.add('completed');
    document.getElementById('step1').classList.remove('active');
    document.getElementById('step2').classList.add('active');
    document.getElementById('section-wifi').classList.add('visible');
  } else {
    document.getElementById('step1').classList.remove('completed');
    document.getElementById('step2').classList.remove('active');
    document.getElementById('section-wifi').classList.remove('visible');
  }
}

function togglePassword() {
  const input = document.getElementById('password');
  const icon = document.querySelector('.input-icon');
  passwordVisible = !passwordVisible;
  
  if(passwordVisible) {
    input.type = 'text';
    icon.textContent = 'üôà';
  } else {
    input.type = 'password';
    icon.textContent = 'üëÅÔ∏è';
  }
}

function loadWifiList() {
  fetch('/wifi-list').then(r=>r.json()).then(list=>{
    let sel=document.getElementById('wifi');
    sel.innerHTML = '';
    list.forEach(n=>{ 
      let o=document.createElement('option'); 
      o.text=n; 
      sel.add(o); 
    });
  });
}

function refreshWifi() {
  setStatus("scanning for networks...", 'connecting');
  loadWifiList();
  setTimeout(() => {
    setStatus("scan complete", 'idle');
  }, 2000);
}

// Initial load
loadWifiList();

// Set initial step as active
document.getElementById('step1').classList.add('active');

// Load firmware version
fetch('/device-info').then(r=>r.json()).then(data=>{
  document.getElementById('firmware-version').textContent = data.firmware || 'v0.0.1';
}).catch(()=>{
  // Fallback if endpoint doesn't exist
  document.getElementById('firmware-version').textContent = 'v0.0.1';
});

function save(){
  setStatus("saving settings...", 'connecting');
  const payload = { 
    name:document.getElementById('name').value, 
    ssid:document.getElementById('wifi').value, 
    pass:document.getElementById('password').value,
    timezone:document.getElementById('timezone').value
  };
  fetch('/save-settings',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify(payload)
  }).then(r=>r.json()).then(d=> {
    setStatus("saved. attempting to join Wi-Fi...", 'connecting');
    document.getElementById('step2').classList.add('completed');
    document.getElementById('step2').classList.remove('active');
    document.getElementById('step3').classList.add('active');
    document.getElementById('section-pair').classList.add('visible');
    document.getElementById('section-wifi').classList.remove('visible');
    setTimeout(() => {
      setStatus("connected to WiFi", 'connected');
    }, 3000);
  });
}

function pair(){
  setStatus("enabling pairing mode. Pair from your phone's Bluetooth settings now.", 'connecting');
  fetch('/start-earbud-pairing',{method:'POST'}).then(r=>r.json()).then(()=>{
    setStatus("pairing mode active", 'connecting');
    document.getElementById('step3').classList.add('completed');
    document.getElementById('step3').classList.remove('active');
    document.getElementById('step4').classList.add('active');
    document.getElementById('section-complete').classList.add('visible');
    document.getElementById('section-pair').classList.remove('visible');
  });
}

function restart(){
  setStatus("rebooting...", 'connecting');
  fetch('/restart',{method:'POST'}).then(()=>{
    setStatus("rebooting now", 'connecting');
    document.getElementById('step4').classList.add('completed');
  });
}

function showFactoryResetModal() {
  document.getElementById('factory-reset-modal').classList.add('show');
}

function hideFactoryResetModal() {
  document.getElementById('factory-reset-modal').classList.remove('show');
}

function confirmFactoryReset() {
  hideFactoryResetModal();
  setStatus("performing factory reset...", 'connecting');
  fetch('/factory-reset',{method:'POST'}).then(()=>{
    setStatus("factory reset complete. rebooting...", 'connecting');
    // Reset all steps
    document.querySelectorAll('.step').forEach(s => s.classList.remove('completed', 'active'));
    document.getElementById('step1').classList.add('active');
    document.getElementById('name').value = '';
    document.getElementById('password').value = '';
    document.getElementById('section-wifi').classList.remove('visible');
    document.getElementById('section-pair').classList.remove('visible');
    document.getElementById('section-complete').classList.remove('visible');
    updateRestartText();
  });
}

// Dark/light mode toggle with corrected icons
const themeToggle = document.getElementById('theme-toggle');

themeToggle.onclick = () => {
  document.body.classList.toggle('light');
  if(document.body.classList.contains('light')){
    themeToggle.textContent = 'üåô';
  } else {
    themeToggle.textContent = '‚òÄÔ∏è';
  }
}
</script>
</body>
</html>